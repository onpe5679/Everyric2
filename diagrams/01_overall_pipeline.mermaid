%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4ECDC4', 'secondaryColor': '#FF6B6B'}}}%%
flowchart TD
    subgraph INPUT["입력"]
        A[오디오 파일<br/>audio.wav]
        B[가사 파일<br/>lyrics.txt]
    end

    subgraph PREPROCESS["전처리"]
        C[AudioLoader<br/>44.1kHz → 16kHz]
        D{--separate?}
        E[Demucs<br/>보컬 분리]
        F[LyricLine.from_file<br/>원본 가사 파싱]
    end

    subgraph ENGINE["Alignment Engine"]
        ENG{--engine?}
        
        subgraph CTC_ENG["CTCEngine (권장)"]
            CTC_LANG{Language?}
            CTC_JA[HuggingFace<br/>wav2vec2-xlsr-ja]
            CTC_KO[HuggingFace<br/>wav2vec2-xlsr-ko]
            CTC_EN[torchaudio<br/>MMS_FA]
            CTC_FA[forced_align<br/>GPU]
        end
        
        subgraph WX_ENG["WhisperXEngine"]
            J[WhisperX<br/>전사 + 매칭]
        end
        
        I[LyricsMatcher<br/>가사 ↔ 타임스탬프 매칭]
    end

    subgraph POSTPROCESS["후처리 파이프라인"]
        SH[SilenceHandler<br/>간주 감지 + 무성구간 병합]
        
        subgraph TRANSLATE["번역 (선택)"]
            G{--translate?}
            TR_FACT{TranslatorFactory}
            TR_GEM[GeminiTranslator]
            TR_OAI[OpenAICompatibleTranslator]
            TR_LOC[Local LLM<br/>Ollama/LM Studio]
            TR_RES[TranslationResult<br/>번역 + 발음]
        end
        
        PF[ProjectFile<br/>.everyric.json 저장]
        SEG[SegmentationProcessor<br/>+ Tokenizer MeCab]
    end

    subgraph OUTPUT["출력"]
        MOG[MultiOutputGenerator]
        
        subgraph LINE_OUT["line 모드"]
            L1[output.srt]
            L2[output_translated.srt]
            L3[output_pronunciation.srt]
            L4[output_full.srt]
        end
        
        subgraph SEG_OUT["word/character 모드<br/>(트랙 분리)"]
            S1[output_word.srt<br/>가사 정밀 타이밍]
            S2[output_translation.srt<br/>번역 줄단위]
            S3[output_pronunciation.srt<br/>발음 줄단위]
        end
        
        M[diagnostics.png]
        N[audio_vocals.wav]
    end

    A --> C
    B --> F
    C --> D
    D -->|Yes| E
    D -->|No| ENG
    E --> ENG
    E --> N
    
    ENG -->|ctc| CTC_LANG
    CTC_LANG -->|ja| CTC_JA
    CTC_LANG -->|ko| CTC_KO
    CTC_LANG -->|en/other| CTC_EN
    CTC_JA --> CTC_FA
    CTC_KO --> CTC_FA
    CTC_EN --> CTC_FA
    CTC_FA --> I
    
    ENG -->|whisperx| J
    
    F -->|원본 가사| ENG
    
    J --> I
    
    I --> SH
    SH --> G
    
    G -->|Yes| TR_FACT
    TR_FACT -->|gemini| TR_GEM
    TR_FACT -->|openai| TR_OAI
    TR_FACT -->|local| TR_LOC
    TR_GEM --> TR_RES
    TR_OAI --> TR_RES
    TR_LOC --> TR_RES
    TR_RES --> PF
    
    G -->|No| PF
    
    PF --> SEG
    SEG --> MOG
    MOG -->|line| LINE_OUT
    MOG -->|word/char| SEG_OUT
    
    I --> M
